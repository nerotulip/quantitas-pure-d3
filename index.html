<!-- index.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Intertopic Clustering</title>
    <link rel="stylesheet" href="styles.css" />
    <script type="text/javascript" src="d3.js"></script>
    <script type="text/javascript" src="lodash.js"></script>
  </head>
  <div id="select-conteiner">
    <select id="selectButtonTopics" class="selectButtonTopics"></select>
  </div>
  <body id="my_dataviz" class="bubblechart">
    <div id="cluster_viz"></div>
    <script>
      fetch("./all.json")
        .then((response) => response.json())
        .then((newData) => {
          const width = 1000
          const height = 900

          const margins = {
            top: 50,
            right: 50,
            left: 60,
            bottom: 50,
          }

          const uniqueCities = [...new Set(newData.map((d) => d.city))]

          const bubbleData = [
            { topic: 1, sizeArea: 10, pc1: 7, pc2: 13 },
            { topic: 2, sizeArea: 4, pc1: 2, pc2: -5 },
            { topic: 3, sizeArea: 5, pc1: -5, pc2: -7 },
            { topic: 4, sizeArea: 2, pc1: 12, pc2: 3 },
            { topic: 5, sizeArea: 15, pc1: -14, pc2: 3 },
            { topic: 6, sizeArea: 18, pc1: -14, pc2: 1 },
            { topic: 7, sizeArea: 15, pc1: 3, pc2: 10 },
          ]

          //BUBBLES SCALES
          const xScaleBubble = d3
            .scaleLinear()
            .domain([-20, 20])
            .range([margins.left, width - margins.right])

          const yScaleBubble = d3
            .scaleLinear()
            .domain([20, -20])
            .range([margins.top, height - margins.bottom])
          const circleScale = d3.scaleSqrt().domain([1, 20]).range([10, 50])

          // BARS SCALES
          const xScaleBars = d3.scaleLinear().domain([0, 0.1]).range([0, 600])

          //SVG BUBBLES /////////////////////////////////////////////////////

          const svgBubbleWrapper = d3.select("#my_dataviz").append("div")

          svgBubbleWrapper
            .append("div")
            .attr("class", "title")
            .text("Intertopic Distance Map (via multidimensional scaling)")

          const svgBubbles = svgBubbleWrapper
            .append("svg")
            .attr("width", width)
            .attr("height", height)
          // AXIS AS SVG LINES
          svgBubbles
            .append("line")
            .attr("x1", margins.left)
            .attr("x2", width - margins.right)
            .attr("y1", height / 2)
            .attr("y2", height / 2)
            .style("stroke", "#BDBDBD")
            .style("opacity", 1)

          svgBubbles
            .append("line")
            .attr("x1", width / 2)
            .attr("x2", width / 2)
            .attr("y1", margins.top)
            .attr("y2", height - margins.bottom)
            .style("stroke", "#BDBDBD")
            .style("opacity", 1)

          function drawBubblePlot(dataset, state) {
            //Bubbles
            svgBubbles
              .selectAll("circle")
              .data(dataset)
              .join("circle")
              .attr("class", "bubbles")
              .attr("id", (d) => `circle-${d.topic}`)
              .attr("cx", (d) => xScaleBubble(d.pc1))
              .attr("cy", (d) => yScaleBubble(d.pc2))
              .attr("r", (d) => circleScale(d.sizeArea))
              .attr("fill", "#61BFE4")
              .style("opacity", 0.75)
              .on("mouseover", function (event) {
                const hoveredTopic = event.target.__data__.topic
                d3.selectAll("circle.bubbles")
                  .transition()
                  .duration(250)
                  .style("opacity", 0.1)
                d3.select(this)
                  .transition()
                  .duration(250)
                  .style("opacity", 0.75)
                d3.select(this).style("fill", "#FD6332")
                const hoveredDataset = newData
                  .filter((d) => d.city === selectedCity)
                  .filter((d) => d.topic === hoveredTopic)

                drawBarChart(hoveredDataset)
              })
              .on("mouseout", function (d) {
                d3.selectAll("circle.bubbles")
                  .style("opacity", 0.75)
                  .style("fill", "#61BFE4")
                drawBarChart(
                  newData
                    .filter((d) => d.city === "province of vicenza")

                    .filter((d) => d.default === "y")
                )
              })

            //Bubbles LABELS
            svgBubbles
              .selectAll("text")
              .data(dataset)
              .join("text")
              .attr("x", (d) => xScaleBubble(d.pc1))
              .attr("y", (d) => yScaleBubble(d.pc2) + 4)
              .attr("font-family", "sans-serif")
              .style("text-anchor", "middle")
              .style("pointer-events", "none")
              .text((d) => d.topic)
          }

          drawBubblePlot(bubbleData)

          //SVG BARS ///////////////////////////////////////////////////////////////////////////////////////////////

          const svgBarsWrapper = d3.select("#my_dataviz").append("div")

          svgBarsWrapper
            .append("div")
            .attr("class", "title")
            .text("Top 30 most salient terms")
          const svgBars = d3
            .select("#my_dataviz")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
          //.append("g")

          const drawBarChart = function (dataset, state) {
            const yScaleBars = d3
              .scaleOrdinal()
              .domain([])
              .range(d3.range(margins.top, height - margins.bottom, 20))

            //RECTS
            svgBars
              .selectAll("rect")
              .data(dataset, (d) => d.word)
              .join("rect")
              .attr("id", (d) => "rect-" + d.word)
              .attr("x", margins.left + 15)
              .attr("y", (d) => yScaleBars(d.word))
              .attr("width", (d) => xScaleBars(d.importance_word))
              .attr("height", 10)
              .attr("rx", 4)
              .attr("ry", 4)
              .attr("fill", state === "default" ? "#61BFE4" : "#FD6332")
              .on("mouseover", function (event) {
                const hoveredBar = event.target.__data__
                svgBars
                  .select("#" + hoveredBar.word)
                  .style("font-weight", "bold")
                svgBars
                  .selectAll("rect")
                  .transition()
                  .duration(250)
                  .style("opacity", 0.2)
                svgBars
                  .select("#rect-" + hoveredBar.word)
                  .transition()
                  .duration(250)
                  .style("opacity", 0.75)

                svgBubbles.selectAll("circle").style("opacity", 0.2)
                svgBubbles
                  .select("#circle-" + hoveredBar.topic)
                  .transition()
                  .duration(250)
                  .style("opacity", 0.75)
                  .style("stroke", "black")
              })
              .on("mouseout", function (event) {
                const hoveredBarOut = event.target.__data__
                svgBars
                  .select("#" + hoveredBarOut.word)
                  .style("font-weight", 400)
                d3.selectAll("circle").style("opacity", 0.75)
                // svgBubbles
                //   .select("#circle-" + hoveredBarOut.topic)
                //   .style("stroke", "")
                svgBubbles.selectAll("circle").style("stroke", "")
                svgBars
                  .selectAll("rect")
                  .transition()
                  .duration(250)
                  .style("opacity", 0.75)
              })

            // WORDS
            svgBars
              .selectAll("text")
              .data(dataset, (d) => d.word)
              .join("text")
              .attr("id", (d) => d.word)
              .attr("x", margins.left + 10)
              .attr("y", (d) => yScaleBars(d.word) + 10)
              .attr("font-family", "sans-serif")
              .text((d) => d.word)
              .style("text-anchor", "end")
              .on("mouseover", function (event) {
                const hoveredWord = event.target.__data__

                d3.select(this).style("font-weight", "800")
              })
              .on("mouseout", function (event) {
                d3.select(this).style("font-weight", "400")
              })
          }

          drawBarChart(
            newData
              .filter((d) => d.city === "province of vicenza")

              .filter((d) => d.default === "y")
          )

          // SELECTION DROPDOWN  //////////////////////////
          d3.select("#selectButtonTopics")
            .selectAll("myOptions")
            .data(uniqueCities)
            .enter()
            .append("option")
            .text(function (d) {
              return d
            })
            .attr("value", function (d) {
              return d
            })

          d3.select("#selectButtonTopics").on("change", function (d) {
            const selectedOption = d3.select(this).property("value")
            //selectedCity = d3.select(this).property("value")
            drawBarChart(
              newData
                .filter((d) => d.city === selectedOption)
                .filter((d) => d.default === "y")
            )
          })
          const selectedCity =
            document.getElementById("selectButtonTopics").value
          console.log(selectedCity, "selected dropdown value")
        })
    </script>
  </body>
</html>
