<!-- index.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Simple D3 Dev Env</title>
    <script type="text/javascript" src="d3.js"></script>
    <script type="text/javascript" src="lodash.js"></script>
  </head>
  <body id="my_dataviz">
    <div id="cluster_viz"></div>
    <script>
      const width = 1000
      const height = 900

      const margins = {
        top: 50,
        right: 50,
        left: 60,
        bottom: 50,
      }

      const defaultData = [
        {
          topic: "standard",
          words: [
            { word: "car", count: 45, topic: 1 },
            { word: "white", count: 30, topic: 2 },
            { word: "great", count: 26, topic: 3 },
            { word: "gin", count: 72, topic: 4 },
            { word: "new york", count: 23, topic: 5 },
            { word: "daisy", count: 67, topic: 6 },
            { word: "gatsby", count: 55, topic: 1 },
            { word: "boat", count: 14, topic: 2 },
            { word: "lake", count: 11, topic: 3 },
            { word: "mountain", count: 13, topic: 4 },
            { word: "states", count: 55, topic: 5 },
            { word: "nicolas", count: 84, topic: 5 },
            { word: "piano", count: 45, topic: 1 },
            { word: "red", count: 30, topic: 2 },
            { word: "shoe", count: 26, topic: 3 },
            { word: "knit", count: 72, topic: 4 },
            { word: "shop", count: 23, topic: 5 },
            { word: "street", count: 67, topic: 6 },
            { word: "bike", count: 55, topic: 1 },
            { word: "light", count: 14, topic: 2 },
            { word: "fish", count: 11, topic: 3 },
            { word: "strike", count: 13, topic: 4 },
            { word: "noise", count: 55, topic: 5 },
            { word: "random", count: 84, topic: 5 },
            { word: "sea", count: 55, topic: 1 },
            { word: "ocean", count: 14, topic: 2 },
            { word: "ship", count: 11, topic: 3 },
            { word: "flight", count: 13, topic: 4 },
            { word: "sonata", count: 55, topic: 5 },
            { word: "adagio", count: 84, topic: 5 },
          ],
        },
        {
          topic: 1,
          words: [
            { word: "car", count: 24 },
            { word: "white", count: 36 },
            { word: "great", count: 12 },
            { word: "gin", count: 6 },
            { word: "new york", count: 30 },
            { word: "daisy", count: 87 },
            { word: "gatsby", count: 74 },
            { word: "boat", count: 23 },
            { word: "lake", count: 24 },
            { word: "mountain", count: 91 },
            { word: "states", count: 45 },
            { word: "jaar", count: 50 },
          ],
        },
        {
          topic: 2,
          words: [
            { word: "car", count: 43 },
            { word: "white", count: 36 },
            { word: "great", count: 12 },
            { word: "gin", count: 6 },
            { word: "new york", count: 30 },
            { word: "daisy", count: 10 },
            { word: "gatsby", count: 74 },
            { word: "boat", count: 22 },
            { word: "lake", count: 24 },
            { word: "mountain", count: 91 },
            { word: "states", count: 45 },
          ],
        },
      ]

      const orderedData = defaultData.map((d) => ({
        ...d,
        words: d.words.sort(function (a, b) {
          return b.count - a.count
        }),
      }))

      console.log(orderedData, "orderedData")

      const bubbleData = [
        { topic: 1, sizeArea: 10, pc1: 7, pc2: 13 },
        { topic: 2, sizeArea: 4, pc1: 2, pc2: -5 },
        { topic: 3, sizeArea: 5, pc1: -5, pc2: -7 },
        { topic: 4, sizeArea: 2, pc1: 12, pc2: 3 },
        { topic: 5, sizeArea: 15, pc1: -14, pc2: 3 },
        { topic: 6, sizeArea: 18, pc1: -14, pc2: 1 },
        { topic: 7, sizeArea: 15, pc1: 3, pc2: 10 },
      ]

      //BUBBLES SCALES
      const xScaleBubble = d3
        .scaleLinear()
        .domain([-20, 20])
        .range([margins.left, width - margins.right])
      const yScaleBubble = d3
        .scaleLinear()
        .domain([20, -20])
        .range([margins.top, height - margins.bottom])
      const circleScale = d3.scaleSqrt().domain([1, 20]).range([10, 50])

      // BARS SCALES
      const xScaleBars = d3.scaleLinear().domain([0, 100]).range([0, 600])

      const dataCustomRects = orderedData
        .filter((d) => d.topic === "standard")
        .map((d) => d.words)[0]

      //SVG BUBBLES /////////////////////////////////////////////////////

      const svgBubbleWrapper = d3.select("#my_dataviz").append("div")

      svgBubbleWrapper.append("div").attr("class", "title").text("miao")

      const svgBubbles = svgBubbleWrapper
        .append("svg")
        .attr("width", width)
        .attr("height", height)
      //.append("g")

      function drawBubblePlot(dataset, state) {
        //Bubbles
        svgBubbles
          .selectAll("circle")
          .data(dataset)
          .join("circle")
          .attr("class", "bubbles")
          .attr("id", (d) => `circle-${d.topic}`)
          .attr("cx", (d) => xScaleBubble(d.pc1))
          .attr("cy", (d) => yScaleBubble(d.pc2))
          .attr("r", (d) => circleScale(d.sizeArea))
          .attr("fill", "#61BFE4")
          .on("mouseover", function (event) {
            const hoveredTopic = event.target.__data__.topic
            d3.selectAll("circle.bubbles").style("opacity", 0.1)
            d3.select(this).style("opacity", 0.7)
            d3.select(this).style("fill", "red")
            const hoveredDataset = orderedData
              .filter((d) => d.topic === hoveredTopic)
              .map((d) => d.words)[0]
            drawBarChart(hoveredDataset)
          })
          .on("mouseout", function (d) {
            d3.selectAll("circle.bubbles")
              .style("opacity", 0.7)
              .style("fill", "#61BFE4")
            drawBarChart(dataCustomRects, "default")
          })

        //Bubbles LABELS
        svgBubbles
          .selectAll("text")
          .data(dataset)
          .join("text")
          .attr("x", (d) => xScaleBubble(d.pc1))
          .attr("y", (d) => yScaleBubble(d.pc2) + 4)
          .attr("font-family", "sans-serif")
          .style("text-anchor", "middle")
          .style("pointer-events", "none")
          .text((d) => d.topic)
      }

      drawBubblePlot(bubbleData)

      console.log(dataCustomRects)

      //SVG BARS ///////////////////////////////////////////////////////////////////////////////////////////////

      const svgBars = d3
        .select("#my_dataviz")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
      //.append("g")

      const drawBarChart = function (dataset, state) {
        const yScaleBars = d3
          .scaleOrdinal()
          .domain([])
          .range(d3.range(margins.top, height - margins.bottom, 20))

        //RECTS
        svgBars
          .selectAll("rect")
          .data(dataset, (d) => d.word)
          .join("rect")
          .attr("id", (d) => "rect-" + d.word)
          .attr("x", margins.left + 15)
          .attr("y", (d) => yScaleBars(d.word))
          .attr("width", (d) => xScaleBars(d.count))
          .attr("height", 10)
          .attr("rx", 4)
          .attr("ry", 4)
          .attr("fill", state === "default" ? "#61BFE4" : "red")
          .on("mouseover", function (event) {
            const hoveredBar = event.target.__data__
            svgBars.select("#" + hoveredBar.word).style("font-weight", "bold")
            svgBars.selectAll("rect").style("opacity", 0.2)
            svgBars.select("#rect-" + hoveredBar.word).style("opacity", 0.75)

            svgBubbles.selectAll("circle").style("opacity", 0.2)
            svgBubbles
              .select("#circle-" + hoveredBar.topic)
              .style("opacity", 0.75)
              .style("stroke", "black")
          })
          .on("mouseout", function (event) {
            const hoveredBarOut = event.target.__data__
            svgBars.select("#" + hoveredBarOut.word).style("font-weight", 400)
            d3.selectAll("circle").style("opacity", 0.75)
            svgBubbles
              .select("#circle-" + hoveredBarOut.topic)
              .style("stroke", "")
            svgBars
              .selectAll("rect")
              .transition()
              .duration(150)
              .style("opacity", 0.75)
          })

        // WORDS
        svgBars
          .selectAll("text")
          .data(dataset, (d) => d.word)
          .join("text")
          .attr("id", (d) => d.word)
          .attr("x", margins.left + 10)
          .attr("y", (d) => yScaleBars(d.word) + 10)
          .attr("font-family", "sans-serif")
          .text((d) => d.word)
          .style("text-anchor", "end")
          .on("mouseover", function (event) {
            const hoveredWord = event.target.__data__

            d3.select(this).style("font-weight", "800")
          })
          .on("mouseout", function (event) {
            d3.select(this).style("font-weight", "400")
          })
      }

      drawBarChart(dataCustomRects, "default")
    </script>
  </body>
</html>
